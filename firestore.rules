rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---- 共用判斷 ----
    function signedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isDocOwner() {
      return signedIn() && resource.data.userId == request.auth.uid;
    }

    function isReqOwner() {
      return signedIn() && request.resource.data.userId == request.auth.uid;
    }

    // ---- users 僅本人可讀寫 ----
    match /users/{uid} {
      allow read, write: if isOwner(uid);
    }

    // ---- App 內需要 userId 欄位的 collections ----
    function appColl(name) {
      return name in ['cards', 'wallets', 'transactions', 'budgets', 'notifications', 'user_tokens'];
    }

    // 讀：文件 userId 必須是本人
    // 新增/更新：request body 的 userId 必須是本人
    // 刪除：文件 userId 必須是本人
    match /{colName}/{docId} {
      allow read:   if appColl(colName) && isDocOwner();
      allow create, update: if appColl(colName) && isReqOwner();
      allow delete: if appColl(colName) && isDocOwner();
    }

    // ---- 匯率：任何人可讀；僅 Cloud Functions 可寫 ----
    match /fx_rates/{doc} {
      allow read: if true;
      allow write: if signedIn() && (
        // 由 Functions 以 custom token 寫入
        (request.auth.token.firebase != null &&
         request.auth.token.firebase.sign_in_provider == 'custom')
        // 或明確帶有自訂角色 'functions'
        || request.auth.token.role == 'functions'
      );
    }
  }
}
